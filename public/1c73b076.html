<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>数据库基础理论 | Jitwxs</title><meta name="author" content="Jitwxs"><meta name="copyright" content="Jitwxs"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、事务的四大特性  ACID   只有满足一致性，事务的执行结果才是正确的。   在无并发的情况下，事务串行执行，隔离性一定能够满足。此时要只要能满足原子性，就一定能满足一致性。   在并发的情况下，多个事务并发执行，事务不仅要满足原子性，还需要满足隔离性，才能满足一致性。   事务满足持久化是为了能应对数据库奔溃的情况。     1.1 原子性 Atomicity 原子性是指事务是一个不可分">
<meta property="og:type" content="article">
<meta property="og:title" content="数据库基础理论">
<meta property="og:url" content="https://jitwxs.cn/1c73b076.html">
<meta property="og:site_name" content="Jitwxs">
<meta property="og:description" content="一、事务的四大特性  ACID   只有满足一致性，事务的执行结果才是正确的。   在无并发的情况下，事务串行执行，隔离性一定能够满足。此时要只要能满足原子性，就一定能满足一致性。   在并发的情况下，多个事务并发执行，事务不仅要满足原子性，还需要满足隔离性，才能满足一致性。   事务满足持久化是为了能应对数据库奔溃的情况。     1.1 原子性 Atomicity 原子性是指事务是一个不可分">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/top/cover10.jpg">
<meta property="article:published_time" content="2018-10-29T03:30:08.000Z">
<meta property="article:modified_time" content="2020-12-26T13:52:06.962Z">
<meta property="article:author" content="Jitwxs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/top/cover10.jpg"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/configuration/favicon.ico"><link rel="canonical" href="https://jitwxs.cn/1c73b076"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?053091e29f160d71ed2f65a774cfeac1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-40VH67TNSM"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-40VH67TNSM');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"POGNXMLA2T","apiKey":"2013ebed0f76818838d693c9c40cb1fd","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Jitwxs","link":"链接: ","source":"来源: Jitwxs","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-right"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-12-26 21:52:06'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Jitwxs" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/configuration/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">224</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">132</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">39</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fas fa-ellipsis-v"></i><span> 更多</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fa fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/favorites/"><i class="fa-fw fas fa-meteor"></i><span> 收藏夹</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://tools.jitwxs.cn"><i class="fa-fw fas fa-tools"></i><span> 工具箱</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-cogs"></i><span> 管理</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/changes/"><i class="fa-fw fas fa-location-arrow"></i><span> 更新日志</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://analytics.google.com/"><i class="fa-fw fab fa-google"></i><span> 谷歌统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://tongji.baidu.com/"><i class="fa-fw fas fa-globe-asia"></i><span> 百度统计</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/top/cover10.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jitwxs</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fas fa-ellipsis-v"></i><span> 更多</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fa fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/favorites/"><i class="fa-fw fas fa-meteor"></i><span> 收藏夹</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://tools.jitwxs.cn"><i class="fa-fw fas fa-tools"></i><span> 工具箱</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-cogs"></i><span> 管理</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/changes/"><i class="fa-fw fas fa-location-arrow"></i><span> 更新日志</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://analytics.google.com/"><i class="fa-fw fab fa-google"></i><span> 谷歌统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://tongji.baidu.com/"><i class="fa-fw fas fa-globe-asia"></i><span> 百度统计</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">数据库基础理论<a class="post-edit-link" href="https://github.com/jitwxs/blog-source/tree/master/source/_posts/数据库基础理论.md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="article-meta"><i class="fas fa-user post-meta-icon"></i><span class="article-meta-label">Jitwxs</span><span class="post-meta-separator">|</span></span><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2018-10-29T03:30:08.000Z" title="发表于 2018-10-29 11:30:08">2018-10-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-12-26T13:52:06.962Z" title="更新于 2020-12-26 21:52:06">2020-12-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>14分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="数据库基础理论"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/1c73b076.html#post-comment"><span class="gitalk-comment-count"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="一-事务的四大特性-acid"><a class="markdownIt-Anchor" href="#一-事务的四大特性-acid"></a> 一、事务的四大特性  ACID</h2>
<ul>
<li>
<p>只有满足一致性，事务的执行结果才是正确的。</p>
</li>
<li>
<p>在无并发的情况下，事务串行执行，隔离性一定能够满足。此时要只要能满足原子性，就一定能满足一致性。</p>
</li>
<li>
<p>在并发的情况下，多个事务并发执行，事务不仅要满足原子性，还需要满足隔离性，才能满足一致性。</p>
</li>
<li>
<p>事务满足持久化是为了能应对数据库奔溃的情况。</p>
</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029095434899.png" alt="" /></p>
<h3 id="11-原子性-atomicity"><a class="markdownIt-Anchor" href="#11-原子性-atomicity"></a> 1.1 原子性 Atomicity</h3>
<p>原子性是指<strong>事务是一个不可分割的工作单位，事务中的操作要么全部成功，要么全部失败</strong>。比如在同一个事务中的SQL语句，要么全部执行成功，要么全部执行失败。</p>
<p>回滚可以用日志来实现，日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。</p>
<h3 id="12-一致性-consistency"><a class="markdownIt-Anchor" href="#12-一致性-consistency"></a> 1.2 一致性 Consistency</h3>
<p><strong>事务必须使数据库从一个一致性状态变换到另外一个一致性状态。</strong> 以转账为例子，A向B转账，假设转账之前这两个用户的钱加起来总共是2000，那么A向B转账之后，不管这两个账户怎么转，A用户的钱和B用户的钱加起来的总额还是2000，这个就是事务的一致性。</p>
<h3 id="13-隔离性-isolation"><a class="markdownIt-Anchor" href="#13-隔离性-isolation"></a> 1.3 隔离性 Isolation</h3>
<p>隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，<strong>多个并发事务之间要相互隔离</strong>。</p>
<p>即要达到这么一种效果：对于任意两个并发的事务 T1 和 T2，在事务 T1 看来，T2 要么在 T1 开始之前就已经结束，要么在 T1 结束之后才开始，这样每个事务都感觉不到有其他事务在并发地执行。</p>
<h3 id="14-持久性-durability"><a class="markdownIt-Anchor" href="#14-持久性-durability"></a> 1.4 持久性 Durability</h3>
<p><strong>一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。</strong></p>
<p>可以通过数据库备份和恢复来实现，在系统发生奔溃时，使用备份的数据库进行数据恢复。</p>
<h2 id="二-并发一致性问题"><a class="markdownIt-Anchor" href="#二-并发一致性问题"></a> 二、并发一致性问题</h2>
<h3 id="21-丢失修改"><a class="markdownIt-Anchor" href="#21-丢失修改"></a> 2.1 丢失修改</h3>
<p>T1 和 T2 两个事务都对一个数据进行修改，T1 先修改，T2 随后修改，T2 的修改覆盖了 T1 的修改。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029095604396.png" alt="" /></p>
<h3 id="22-脏读"><a class="markdownIt-Anchor" href="#22-脏读"></a> 2.2 脏读</h3>
<p>如果一个事务中对数据进行了更新，但事务还没有提交，另一个事务可以 “看到” 该事务没有提交的更新结果，这样造成的问题就是，如果第一个事务回滚，那么，第二个事务在此之前所 “看到” 的数据就是一笔脏数据。（脏读又称无效数据读出， <strong>一个事务读取另外一个事务还没有提交的数据叫脏读</strong>。）</p>
<p><strong>例子：</strong></p>
<ol>
<li>Mary 的原工资为 1000, 财务人员将 Mary 的工资改为了 8000 (但未提交事务)</li>
<li>Mary 读取自己的工资，发现自己的工资变为了 8000，欢天喜地！</li>
<li>而财务发现操作有误，回滚了事务，Mary 的工资又变为了1000</li>
<li>像这样，Mary记取的工资数8000是一个脏数据。</li>
</ol>
<p><strong>解决办法：</strong><br />
　　把数据库的事务隔离级别调整到 READ_COMMITTED</p>
<p><strong>图解：</strong><br />
　　T1 修改一个数据，T2 随后读取这个数据。如果 T1 撤销了这次修改，那么 T2 读取的数据是脏数据。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029095827539.png" alt="" /></p>
<h3 id="23-不可重复读"><a class="markdownIt-Anchor" href="#23-不可重复读"></a> 2.3 不可重复读</h3>
<p>是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样在一个事务内两次读到的数据是不一样的，因此称为是<code>不可重复读</code>。（同时操作，事务1分别读取事务2操作时和提交后的数据，读取的记录内容不一致。<strong>不可重复读是指在同一个事务内，两个相同的查询返回了不同的结果。</strong> ）</p>
<p><strong>例子：</strong></p>
<ol>
<li>在事务1中，Mary 读取了自己的工资为1000，操作并没有完成</li>
<li>在事务2中，这时财务人员修改了 Mary 的工资为 2000，并提交了事务</li>
<li>在事务1中，Mary 再次读取自己的工资时，工资变为了2000</li>
</ol>
<p><strong>解决办法：</strong><br />
　　如果只有在修改事务完全提交之后才可以读取数据，则可以避免该问题。把数据库的事务隔离级别调整到REPEATABLE_READ</p>
<p><strong>图解：</strong><br />
　　T2 读取一个数据，T1 对该数据做了修改。如果 T2 再次读取这个数据，此时读取的结果和第一次读取的结果不同。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029100120874.png" alt="" /></p>
<h3 id="24-幻读"><a class="markdownIt-Anchor" href="#24-幻读"></a> 2.4 幻读</h3>
<p>事务 T1 读取一条指定的 Where 子句所返回的结果集，然后 T2 事务新插入一行记录，这行记录恰好可以满足T1 所使用的查询条件。然后 T1 再次对表进行检索，但又看到了 T2 插入的数据。 （<strong>和可重复读类似，但是事务 T2 的数据操作仅仅是插入和删除，不是修改数据，读取的记录数量前后不一致</strong>）。<strong>幻读的重点在于新增或者删除 (数据条数变化)</strong>，同样的条件，第1次和第2次读出来的记录数不一样。</p>
<p><strong>例子：</strong></p>
<ol>
<li>事务1，读取所有工资为 1000 的员工（共读取 10 条记录 ）</li>
<li>这时另一个事务向 employee 表插入了一条员工记录，工资也为 1000</li>
<li>事务1再次读取所有工资为 1000的 员工（共读取到了 11 条记录，这就产生了幻读）</li>
</ol>
<p><strong>解决办法：</strong><br />
　　如果在操作事务完成数据处理之前，任何其他事务都不可以添加新数据，则可避免该问题。把数据库的事务隔离级别调整到 SERIALIZABLE_READ</p>
<p><strong>图解：</strong><br />
　　T1 读取某个范围的数据，T2 在这个范围内插入新的数据，T1 再次读取这个范围的数据，此时读取的结果和和第一次读取的结果不同。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029100710886.png" alt="" /></p>
<h2 id="三-事务隔离级别"><a class="markdownIt-Anchor" href="#三-事务隔离级别"></a> 三、事务隔离级别</h2>
<table>
<thead>
<tr>
<th style="text-align:left">读数据一致性及允许的并发副作用隔离级别</th>
<th style="text-align:left">读数据一致性</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">未提交读</td>
<td style="text-align:left">最低级别，只能保证不读取物理上损坏的数据</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td style="text-align:left">已提交读</td>
<td style="text-align:left">语句级</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td style="text-align:left">可重复读</td>
<td style="text-align:left">事务级</td>
<td>N</td>
<td>N</td>
<td>Y</td>
</tr>
<tr>
<td style="text-align:left">可序列化</td>
<td style="text-align:left">最高级别，事务级</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
</tbody>
</table>
<h3 id="31-未提交读-read-uncommitted"><a class="markdownIt-Anchor" href="#31-未提交读-read-uncommitted"></a> 3.1 未提交读 Read Uncommitted</h3>
<p>最低的隔离等级，允许其他事务看到没有提交的数据，<strong>会导致脏读</strong>。</p>
<h3 id="32-已提交读-read-committed"><a class="markdownIt-Anchor" href="#32-已提交读-read-committed"></a> 3.2 已提交读 Read Committed</h3>
<p><strong>被读取的数据可以被其他事务修改</strong>，这样可能导致不可重复读。也就是说，事务读取的时候获取读锁，但是在读完之后立即释放(不需要等事务结束)，而写锁则是事务提交之后才释放，释放读锁之后，就可能被其他事务修改数据。</p>
<p>该等级也是 SQL Server、Oracle 默认的隔离等级。</p>
<h3 id="33-可重复读-repeated-read"><a class="markdownIt-Anchor" href="#33-可重复读-repeated-read"></a> 3.3 可重复读 Repeated Read</h3>
<p><strong>所有被选中获取的数据都不能被修改</strong>，这样就可以避免一个事务前后读取数据不一致的情况。<strong>但是却没有办法控制幻读</strong>，因为这个时候其他事务不能更改所选的数据，但是可以增加数据，<strong>即前一个事务有读锁但是没有范围锁</strong>，为什么叫做可重复读等级呢？那是因为该等级解决了下面的不可重复读问题。</p>
<p>该等级也是 MySQL 默认的隔离等级。</p>
<blockquote>
<p>引申：现在主流数据库都使用 MVCC 并发控制，使用之后 RR（可重复读）隔离级别下是不会出现幻读的现象。</p>
</blockquote>
<h3 id="34-串行化-serializable"><a class="markdownIt-Anchor" href="#34-串行化-serializable"></a> 3.4 串行化 Serializable</h3>
<p>所有事务一个接着一个的执行，这样<strong>可以避免幻读 (phantom read)</strong>，对于基于锁来实现并发控制的数据库来说，串行化要求在执行范围查询的时候，需要获取范围锁，如果不是基于锁实现并发控制的数据库，则检查到有违反串行操作的事务时，需回滚该事务。</p>
<h2 id="四-myisam-vs-innodb"><a class="markdownIt-Anchor" href="#四-myisam-vs-innodb"></a> 四、MyISAM VS InnoDB</h2>
<table>
<thead>
<tr>
<th>对比项</th>
<th>MyISAM</th>
<th>InnoDB</th>
</tr>
</thead>
<tbody>
<tr>
<td>主外键</td>
<td>N</td>
<td>Y</td>
</tr>
<tr>
<td>事务</td>
<td>N</td>
<td>Y</td>
</tr>
<tr>
<td>行表锁</td>
<td>表锁，即使操作一条记录也会锁住整个表</td>
<td>行锁，操作时只锁某一行，不对其他行有影响</td>
</tr>
<tr>
<td>缓存</td>
<td>只缓存索引，不缓存真实数据</td>
<td>不仅缓存索引还缓存真实数据，内存要求较高，且内存大小对性能有决定性的影响</td>
</tr>
<tr>
<td>表空间</td>
<td>小</td>
<td>大</td>
</tr>
<tr>
<td>关注点</td>
<td>性能</td>
<td>事务</td>
</tr>
<tr>
<td>默认安装</td>
<td>Y</td>
<td>Y</td>
</tr>
</tbody>
</table>
<h2 id="五-锁机制"><a class="markdownIt-Anchor" href="#五-锁机制"></a> 五、锁机制</h2>
<h3 id="51-乐观锁-悲观锁"><a class="markdownIt-Anchor" href="#51-乐观锁-悲观锁"></a> 5.1 乐观锁、悲观锁</h3>
<p><strong>1.乐观锁</strong><br />
顾名思义，就是很乐观，<strong>每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据</strong>，可以使用版本号等机制。</p>
<p>乐观锁适用于多读的应用类型，这样可以提高吞吐量，像数据库如果提供类似于write_condition机制的其实都是提供的乐观锁。</p>
<p><strong>2.悲观锁</strong><br />
顾名思义，就是很悲观，<strong>每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会block直到它拿到锁</strong>。</p>
<p>传统的关系型数据库里边就用到了很多这种锁机制，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁。</p>
<h3 id="52-表锁"><a class="markdownIt-Anchor" href="#52-表锁"></a> 5.2 表锁</h3>
<p><strong>1.表共享读锁（Table Read Lock）</strong><br />
对MyISAM表进行读操作时，它不会阻塞其他用户对同一表的读请求，但会阻塞对同一表的写操作。</p>
<p><strong>2.表独占写锁（Table Write Lock）</strong><br />
对MyISAM表的写操作，则会阻塞其他用户对同一表的读和写操作。</p>
<h3 id="53-行锁"><a class="markdownIt-Anchor" href="#53-行锁"></a> 5.3 行锁</h3>
<p><strong>1. 共享锁（S）</strong><br />
共享锁又称为<code>读锁</code>。若事务T对数据对象A加上 S 锁，则事务T可以读A 但不能修改A，其他事务只能再对A加 S 锁，而不能加X锁，直到T释放A上的 S 锁。这就保证了其他事务可以读A，但在T释放A上的S锁之前不能对A做任何修改。</p>
<p><strong>2. 排他锁（X）</strong><br />
排它锁又称为<code>写锁</code>。若事务T对数据对象A加上 X 锁，则允许T读取和修改A，其他任何事务都不能再对A加任何类型的锁，直到T释放A上的锁。这就保证了其他事务在T释放A上的锁之前不能再读取和修改A。</p>
<p><strong>3. 意向共享锁（IS）</strong><br />
表示事务准备给数据行加入共享锁，也就是说一个数据行加共享锁前必须先取得该表的 IS 锁。如果需要对记录 A 加共享锁，那么此时 InnoDB 会先找到这张表，对该表加意向共享锁之后，再对记录 A 添加共享锁。</p>
<p><strong>4. 意向排他锁（IX）</strong><br />
类似上面，表示事务准备给数据行加入排他锁，也就是说事务在给一个数据行加排他锁前必须先取得该表的 IX 锁。如果需要对记录 A 加排他锁，那么此时 InnoDB 会先找到这张表，对该表加意向排他锁之后，再对记录 A 添加排他锁。</p>
<h2 id="六-索引"><a class="markdownIt-Anchor" href="#六-索引"></a> 六、索引</h2>
<p>索引（Index）是帮助MySQL高效获取数据的数据结构，可以被理解为<strong>排好序的快速查找数据结构</strong>。</p>
<p>一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储在磁盘上。</p>
<p>我们通常所说的索引，如果没有特别指明，都是指B树（多路搜索树，并不一定是二叉的）结构组织的索引。其中聚集索引、次要索引、覆盖索引、混合索引、前缀索引、唯一索引默认都是使用B+树索引，统称索引。</p>
<h3 id="61-索引的特点"><a class="markdownIt-Anchor" href="#61-索引的特点"></a> 6.1 索引的特点</h3>
<ol>
<li>可以<strong>加快数据库的检索速度</strong></li>
<li><strong>降低数据库插入、修改、删除等维护的速度</strong></li>
<li><strong>只能创建在表上，不能创建到视图上</strong></li>
<li>既可以直接创建又可以间接创建</li>
<li>可以在优化隐藏中使用索引</li>
<li>使用查询处理器执行SQL语句，<strong>在一个表上，一次只能使用一个索引</strong></li>
</ol>
<h3 id="62-索引的优点"><a class="markdownIt-Anchor" href="#62-索引的优点"></a> 6.2 索引的优点</h3>
<ol>
<li><strong>创建唯一性索引，保证数据库表中每一行数据的唯一性</strong></li>
<li><strong>大大加快数据的检索速度</strong>，这是创建索引的最主要的原因</li>
<li><strong>加速数据库表之间的连接</strong>，特别是在实现数据的参考完整性方面特别有意义</li>
<li>在使用分组和排序子句进行数据检索时，同样可以<strong>显著减少查询中分组和排序的时间</strong></li>
<li>通过使用索引，可以<strong>在查询中使用优化隐藏器，提高系统的性能</strong></li>
</ol>
<h3 id="63-索引的缺点"><a class="markdownIt-Anchor" href="#63-索引的缺点"></a> 6.3 索引的缺点</h3>
<ol>
<li><strong>创建索引和维护索引要耗费时间</strong>，这种时间随着数据量的增加而增加</li>
<li><strong>索引需要占用物理空间</strong>，除了数据表占用数据空间之外，每一个索引还要占一定的物理空间，如果建立聚簇索引，那么需要的空间就会更大</li>
<li>当对表中的数据进行增加、删除和修改的时候，<strong>索引也需要维护，降低数据维护的速度</strong></li>
</ol>
<h3 id="64-不会使用索引的时机"><a class="markdownIt-Anchor" href="#64-不会使用索引的时机"></a> 6.4 不会使用索引的时机</h3>
<ol>
<li>如果MySQL估计<strong>使用全表扫秒比使用索引快</strong>，则不适用索引。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table_name <span class="keyword">where</span> key<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">and</span> key<span class="operator">&lt;</span><span class="number">90</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>如果列key均匀分布在<span class="number">1</span>和<span class="number">100</span>之间，这个查询使用索引就不是很好</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>如果<strong>条件中有or</strong>，即使其中有条件带索引也不会使用。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table_name <span class="keyword">where</span> key1<span class="operator">=</span><span class="string">&#x27;a&#x27;</span> <span class="keyword">or</span> key2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>在key1上有索引而在key2上没有索引，则该查询也不会走索引</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>复合索引，如果<strong>索引列不是复合索引的第一部分</strong>，则不使用索引（即不符合最左前缀）。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table_name <span class="keyword">where</span> key2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>符合索引为(key1,key2),则查询将不会使用索引</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><strong>如果like是以 % 开始的</strong>，则该列上的索引不会被使用。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table_name <span class="keyword">where</span> key1 <span class="keyword">like</span> <span class="string">&#x27;%a&#x27;</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>该查询即使key1上存在索引，也不会被使用如果列类型是字符串，那一定要在条件中使用引号引起来，否则不会使用索引</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><strong>如果列为字符串，则where条件中必须将字符常量值加引号</strong>，否则即使该列上存在索引，也不会被使用。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table_name <span class="keyword">where</span> key1<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>如果key1列保存的是字符串，即使key1上有索引，也不会被使用。</span><br></pre></td></tr></table></figure>
<h3 id="65-适合建立索引的时机"><a class="markdownIt-Anchor" href="#65-适合建立索引的时机"></a> 6.5 适合建立索引的时机</h3>
<ol>
<li>为经常出现在关键字order by、group by、distinct后面的字段，建立索引。</li>
<li>在union等集合操作的结果集字段上，建立索引。</li>
<li>经常用作查询选择 where 后的字段，建立索引。</li>
<li>在经常用作表连接 join 的属性上，建立索引。</li>
<li>考虑使用索引覆盖。对数据很少被更新的表，如果用户经常只查询其中的几个字段，可以考虑在这几个字段上建立索引，从而将表的扫描改变为索引的扫描。</li>
</ol>
<h3 id="66-索引分类"><a class="markdownIt-Anchor" href="#66-索引分类"></a> 6.6 索引分类</h3>
<h4 id="661-单值索引"><a class="markdownIt-Anchor" href="#661-单值索引"></a> 6.6.1 单值索引</h4>
<p>即一个索引只包含单个列，一个表可以有多个单值索引。</p>
<h4 id="662-唯一索引"><a class="markdownIt-Anchor" href="#662-唯一索引"></a> 6.6.2 唯一索引</h4>
<p>索引列的值必须唯一，但允许有空值。</p>
<h4 id="663-联合索引"><a class="markdownIt-Anchor" href="#663-联合索引"></a> 6.6.3 联合索引</h4>
<p>两个或更多个列上的索引被称作<code>联合索引</code>，联合索引又叫复合索引。对于复合索引：Mysql 从左到右的使用索引中的字段，<strong>一个查询可以只使用索引中的一部份，但只能是最左侧部分</strong>。</p>
<p>例如索引是key index (a,b,c)，可以支持[a]、[a,b]、[a,b,c] 3种组合进行查找，但不支 [b,c] 进行查找。当最左侧字段是常量引用时，索引就十分有效。</p>
<h2 id="七-join"><a class="markdownIt-Anchor" href="#七-join"></a> 七、JOIN</h2>
<p>例如我们有两张表，Orders 表通过外键 Id_P 和 Persons 表进行关联。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029104719466.png" alt="" /></p>
<h3 id="71-inner-join"><a class="markdownIt-Anchor" href="#71-inner-join"></a> 7.1 inner join</h3>
<p>在两张表进行连接查询时，只保留两张表中完全匹配的结果集。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029104804674.png" alt="inner join" /></p>
<p>我们使用 inner join 对两张表进行连接查询，sql如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Persons.LastName, Persons.FirstName, Orders.OrderNo</span><br><span class="line"><span class="keyword">FROM</span> Persons</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Orders</span><br><span class="line"><span class="keyword">ON</span> Persons.Id_P<span class="operator">=</span>Orders.Id_P</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> Persons.LastName</span><br></pre></td></tr></table></figure>
<p>查询结果集如下，此种连接方式 Orders 表中 Id_P 字段在 Persons 表中找不到匹配的，则不会列出来。<br />
<img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029104912547.png" alt="" /></p>
<h3 id="72-left-join"><a class="markdownIt-Anchor" href="#72-left-join"></a> 7.2 left join</h3>
<p>在两张表进行连接查询时，会返回左表所有的行，即使在右表中没有匹配的记录。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029105008722.png" alt="left join" /></p>
<p>我们使用 left join 对两张表进行连接查询，sql如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Persons.LastName, Persons.FirstName, Orders.OrderNo</span><br><span class="line"><span class="keyword">FROM</span> Persons</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> Orders</span><br><span class="line"><span class="keyword">ON</span> Persons.Id_P<span class="operator">=</span>Orders.Id_P</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> Persons.LastName</span><br></pre></td></tr></table></figure>
<p>查询结果如下，可以看到，左表（Persons表）中 LastName 为 Bush 的行的 Id_P 字段在右表（Orders表）中没有匹配，但查询结果仍然保留该行。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029105058750.png" alt="" /></p>
<h3 id="73-right-join"><a class="markdownIt-Anchor" href="#73-right-join"></a> 7.3 right join</h3>
<p>在两张表进行连接查询时，会返回右表所有的行，即使在左表中没有匹配的记录。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029105124968.png" alt="right join" /></p>
<p>我们使用right join对两张表进行连接查询，sql如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Persons.LastName, Persons.FirstName, Orders.OrderNo</span><br><span class="line"><span class="keyword">FROM</span> Persons</span><br><span class="line"><span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> Orders</span><br><span class="line"><span class="keyword">ON</span> Persons.Id_P<span class="operator">=</span>Orders.Id_P</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> Persons.LastName</span><br></pre></td></tr></table></figure>
<p>查询结果如下，Orders 表中最后一条记录 Id_P 字段值为 65，在左表中没有记录与之匹配，但依然保留。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029105211560.png" alt="" /></p>
<h3 id="74-full-join"><a class="markdownIt-Anchor" href="#74-full-join"></a> 7.4 full join</h3>
<p>在两张表进行连接查询时，返回左表和右表中所有没有匹配的行。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029105239918.png" alt="full join" /></p>
<p>我们使用 full join 对两张表进行连接查询，sql如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Persons.LastName, Persons.FirstName, Orders.OrderNo</span><br><span class="line"><span class="keyword">FROM</span> Persons</span><br><span class="line"><span class="keyword">FULL</span> <span class="keyword">JOIN</span> Orders</span><br><span class="line"><span class="keyword">ON</span> Persons.Id_P<span class="operator">=</span>Orders.Id_P</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> Persons.LastName</span><br></pre></td></tr></table></figure>
<p>查询结果如下，查询结果是 left join 和 right join 的并集。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/posts/201810/20181029105333178.png" alt="" /></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Jitwxs</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://jitwxs.cn/1c73b076.html">https://jitwxs.cn/1c73b076.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jitwxs.cn" target="_blank">Jitwxs</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/top/cover10.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/configuration/wechat_donate.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/configuration/wechat_donate.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/configuration/alipay_donate.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/configuration/alipay_donate.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/6533bf70.html"><img class="prev-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/top/cover16.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Git Fork 后与源作者同步更新</div></div></a></div><div class="next-post pull-right"><a href="/975248fa.html"><img class="next-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/top/cover8.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">热度算法和个性化推荐</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/configuration/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Jitwxs</div><div class="author-info__description">不忘初心，砥砺前行</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">224</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">132</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">39</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/jitwxs"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/jitwxs" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=Ujg7JiUqIRI0PSo-Mzs_fDE9Pw" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a><a class="social-icon" href="https://jitwxs.blog.csdn.net" target="_blank" title="CSDN"><i class="fab fa-cuttlefish flat-btn"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">专注 Java 后端开发，内容涵盖 SpringBoot、并发编程、微服务、容器化、Linux 等技术分享。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%9B%9B%E5%A4%A7%E7%89%B9%E6%80%A7-acid"><span class="toc-text"> 一、事务的四大特性  ACID</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E5%8E%9F%E5%AD%90%E6%80%A7-atomicity"><span class="toc-text"> 1.1 原子性 Atomicity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E4%B8%80%E8%87%B4%E6%80%A7-consistency"><span class="toc-text"> 1.2 一致性 Consistency</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-%E9%9A%94%E7%A6%BB%E6%80%A7-isolation"><span class="toc-text"> 1.3 隔离性 Isolation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-%E6%8C%81%E4%B9%85%E6%80%A7-durability"><span class="toc-text"> 1.4 持久性 Durability</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%B9%B6%E5%8F%91%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text"> 二、并发一致性问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E4%B8%A2%E5%A4%B1%E4%BF%AE%E6%94%B9"><span class="toc-text"> 2.1 丢失修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-%E8%84%8F%E8%AF%BB"><span class="toc-text"> 2.2 脏读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB"><span class="toc-text"> 2.3 不可重复读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-%E5%B9%BB%E8%AF%BB"><span class="toc-text"> 2.4 幻读</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-text"> 三、事务隔离级别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-%E6%9C%AA%E6%8F%90%E4%BA%A4%E8%AF%BB-read-uncommitted"><span class="toc-text"> 3.1 未提交读 Read Uncommitted</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-%E5%B7%B2%E6%8F%90%E4%BA%A4%E8%AF%BB-read-committed"><span class="toc-text"> 3.2 已提交读 Read Committed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB-repeated-read"><span class="toc-text"> 3.3 可重复读 Repeated Read</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-%E4%B8%B2%E8%A1%8C%E5%8C%96-serializable"><span class="toc-text"> 3.4 串行化 Serializable</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-myisam-vs-innodb"><span class="toc-text"> 四、MyISAM VS InnoDB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E9%94%81%E6%9C%BA%E5%88%B6"><span class="toc-text"> 五、锁机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#51-%E4%B9%90%E8%A7%82%E9%94%81-%E6%82%B2%E8%A7%82%E9%94%81"><span class="toc-text"> 5.1 乐观锁、悲观锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#52-%E8%A1%A8%E9%94%81"><span class="toc-text"> 5.2 表锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#53-%E8%A1%8C%E9%94%81"><span class="toc-text"> 5.3 行锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E7%B4%A2%E5%BC%95"><span class="toc-text"> 六、索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#61-%E7%B4%A2%E5%BC%95%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-text"> 6.1 索引的特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#62-%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-text"> 6.2 索引的优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#63-%E7%B4%A2%E5%BC%95%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-text"> 6.3 索引的缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#64-%E4%B8%8D%E4%BC%9A%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="toc-text"> 6.4 不会使用索引的时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#65-%E9%80%82%E5%90%88%E5%BB%BA%E7%AB%8B%E7%B4%A2%E5%BC%95%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="toc-text"> 6.5 适合建立索引的时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#66-%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB"><span class="toc-text"> 6.6 索引分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#661-%E5%8D%95%E5%80%BC%E7%B4%A2%E5%BC%95"><span class="toc-text"> 6.6.1 单值索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#662-%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95"><span class="toc-text"> 6.6.2 唯一索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#663-%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95"><span class="toc-text"> 6.6.3 联合索引</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-join"><span class="toc-text"> 七、JOIN</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#71-inner-join"><span class="toc-text"> 7.1 inner join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#72-left-join"><span class="toc-text"> 7.2 left join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#73-right-join"><span class="toc-text"> 7.3 right join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#74-full-join"><span class="toc-text"> 7.4 full join</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/e4d53ddb.html" title="Spring SchedulingConfigurer 实现动态定时任务"><img data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/top/cover2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring SchedulingConfigurer 实现动态定时任务"/></a><div class="content"><a class="title" href="/e4d53ddb.html" title="Spring SchedulingConfigurer 实现动态定时任务">Spring SchedulingConfigurer 实现动态定时任务</a><time datetime="2021-03-27T15:23:41.000Z" title="发表于 2021-03-27 23:23:41">2021-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/9f878221.html" title="Java 双亲委派机制"><img data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/top/cover2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java 双亲委派机制"/></a><div class="content"><a class="title" href="/9f878221.html" title="Java 双亲委派机制">Java 双亲委派机制</a><time datetime="2021-03-14T03:26:34.000Z" title="发表于 2021-03-14 11:26:34">2021-03-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/bef70352.html" title="图解 | 你管这破玩意儿叫TCP？"><img data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/top/cover13.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="图解 | 你管这破玩意儿叫TCP？"/></a><div class="content"><a class="title" href="/bef70352.html" title="图解 | 你管这破玩意儿叫TCP？">图解 | 你管这破玩意儿叫TCP？</a><time datetime="2021-01-24T07:19:23.000Z" title="发表于 2021-01-24 15:19:23">2021-01-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/c376af5e.html" title="图解 | 你管这破玩意叫线程池？"><img data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/top/cover21.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="图解 | 你管这破玩意叫线程池？"/></a><div class="content"><a class="title" href="/c376af5e.html" title="图解 | 你管这破玩意叫线程池？">图解 | 你管这破玩意叫线程池？</a><time datetime="2021-01-23T11:23:54.000Z" title="发表于 2021-01-23 19:23:54">2021-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/93fdc2b.html" title="如果让你来设计网络"><img data-lazy-src="https://cdn.jsdelivr.net/gh/jitwxs/cdn/blog/top/cover1.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="如果让你来设计网络"/></a><div class="content"><a class="title" href="/93fdc2b.html" title="如果让你来设计网络">如果让你来设计网络</a><time datetime="2021-01-23T07:39:03.000Z" title="发表于 2021-01-23 15:39:03">2021-01-23</time></div></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient(135deg,"><div id="footer-wrap"><div class="copyright">&copy;2016 - 2021 By Jitwxs</div><div class="footer_custom_text"><a target="_blank" rel="noopener" href='http://www.beian.miit.gov.cn/state/outPortal/loginPortal.action'><img class='icp-icon entered loading' src='/img/icp.png' alt='ICP' data-ll-status='loading'>苏 ICP 备 16061429 号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    let id = md5(decodeURI(window.location.pathname));
    var gitalk = new Gitalk(Object.assign({
      clientID: '1abf6b8c844664e07e3e',
      clientSecret: '49e497f91b34805a5d19dd73b6d4493d84020782',
      repo: 'blog-comment',
      owner: 'jitwxs',
      admin: ['jitwxs'],
      id: id,
      language: 'en',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const findTrueUrl = (array) => {
    let url = ''
    Promise.all(array.map(item =>
      fetch(item.url).then(resp => resp.json()).then(data => {
        if (data.user.login === 'utterances-bot') {
          url = data.body.match(/https?\:\/\/[^\" ]+/ig).slice(-1)
          return url[0]
        } else {
          url = data.body.match(/https?\:\/\/[^\" ]+/i)
          return url[0]
        }
      })
    )).then(res => {
        array = array.map((i,index)=> {
          return {
            ...i,
            url: res[index]
          }
        })

        saveToLocal.set('github-newest-comments', JSON.stringify(array), 10/(60*24))
        generateHtml(array)
    });
  }

  const getComment = () => {
    fetch('https://api.github.com/repos/jitwxs/blog-comment/issues/comments?sort=updated&direction=desc&per_page=6&page=1',{
      "headers": {
        Accept: 'application/vnd.github.v3.html+json'
      }
    })
      .then(response => response.json())
      .then(data => {
        const githubArray = data.map(item => {
          return {
            'avatar': item.user.avatar_url,
            'content': changeContent(item.body_html),
            'nick': item.user.login,
            'url': item.issue_url,
            'date': item.updated_at,
            'githubUrl': item.html_url
          }
        })
        findTrueUrl(githubArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "无法获取评论，请确认相关配置是否正确"
      })
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('github-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div class="aplayer no-destroy" data-id="5273081683" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="true" data-lrctype="1" muted></div><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.17.0/js/md5.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-40VH67TNSM', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>